---
title: "Make manuscript figures"
output: html_notebook
---

This script is to make cleaner, consistently formatted figures for the manuscript.

Load libraries
```{r}
library(ggtree)
library(ggplot2)
library(dplyr)
library(POUMM)
library(ape)
library(cowplot)

FIGDIR <- "figures"

source("scripts/R/functions/plot_functions.R")
source("scripts/R/functions/utility_functions.R")
```

Define formatting
```{r}
diverging_palette <- "Set2"
gradient_palette <- "PiYG"
shared_theme <- theme_bw()
linewidth <- 16.5  # cm
height <- 11  # cm

gv_name <- "Pathogen part of trait"
gh_name <- "Host part of trait"
e_name <- "Non-pathogen part of trait"
ehat_name <- "Estimated non-pathogen part of trait"
z_minus_zbar_name <- "Scaled trait value"
```

Load data
```{r}
accuracy_simulation_results <- read.delim("output/2021-08-31_estimator_accuracy_MLE.txt")
tpr_simulation_results <- read.delim("output/2021-08-31_GWAS_TPR_MLE.txt")
```

Model illustration
```{r}
# Simulate many OU trajectories along tree
generate_trait_trajectory <- function(v0, alpha, theta, sigma, N_steps) {
  POUMM::rTrajectoryOU(
    z0 = v0,
    t = 1,
    alpha = alpha,
    theta = theta,
    sigma = sigma,
    steps = N_steps)
}

# Generate tree
set.seed(10)
tree <- ape::rtree(n = 3)
tree$edge.length <- tree$edge.length * 6
node_times <- POUMM::nodeTimes(tree)
edge_colors = RColorBrewer::brewer.pal(n = 4, name = diverging_palette)

# Define OU process
scale_factor <- 40  # 1000
v0 <- 3.5
theta <- 4.5
alpha <- 50 / scale_factor
sigma <- 3 / sqrt(scale_factor)

# Initialize data structures
traceplot <- as.data.frame(matrix(ncol = 4, nrow = 0))
colnames(traceplot) <- c("lineage", "time", "v", "color")
v_nodes <- rep(v0, length(node_times))

# Generate OU trajectory for each edge on tree
for (j in 1:nrow(tree$edge)) {
  from = tree$edge[j, 1]
  to = tree$edge[j, 2]
  N_steps = round(tree$edge.length[j]*scale_factor) - 1
  print(paste(N_steps, "steps on branch", j))

  trajectory <- POUMM::rTrajectoryOU(
    z0 = v_nodes[from],
    t = 0.01,
    alpha = alpha,
    theta = theta,
    sigma = sigma,
    steps = N_steps)

  v_nodes[to] <- trajectory[N_steps]
  v <- c(v_nodes[from], trajectory)

  new_data <- data.frame(
    lineage = rep(j, N_steps + 1),
    time = seq(node_times[from], node_times[to], length.out = N_steps + 1),
    v = v,
    color = rep(edge_colors[j], N_steps + 1))
  traceplot <- rbind(traceplot, new_data)
}

mu_OU <- function(t) v0 * exp(-alpha * t) + theta * (1 - exp(-alpha * t))

OU_plot <- ggplot(
  data = traceplot,
  aes(x = time, y = v, group = lineage, color = I(color))) +
  geom_line(size = 1.25) +
  labs(
    x = expression('Substitutions site'^-1 * ' year'^-1),
    y = expression(italic(g)[v])) +
  shared_theme +
  stat_function(fun = mu_OU, color = "black", linetype = "dashed")

#TODO: I have no idea how the edge coloring works, this is a really shitty hardcoded soln
tree_data = data.frame(node = c(1, 2, 3, 4, 5), color = c(edge_colors[2], edge_colors[3], edge_colors[4], "blue", edge_colors[1]))

tree_plot <- ggtree::ggtree(
  tree,
  ladderize = F,
  size = 1.5) %<+% tree_data + aes(color = I(color)) +
  labs(x = expression('Substitutions site'^-1 * ' year'^-1))

e_data <- data.frame(x = c(-1, 1))

e_plot <-  ggplot(data = e_data, aes(x)) +
  stat_function(fun = dnorm,
                n = 101,
                args = list(mean = 0, sd = 0.2),
                size = 1) +
  ylab("Density") +
  shared_theme +
  labs(x = expression(italic(e)))

# Align OU and tree plots
left_side <- plot_grid(OU_plot, tree_plot, align = "v", axis = "lr", nrow = 2, rel_heights = c(2, 1), labels = c("A", "C"))
right_side <- plot_grid(NULL, e_plot, NULL, nrow = 3, rel_heights = c(1, 2, 1), labels = c("", "B", ""))

png(
  filename = paste(FIGDIR, "model_figure.png", sep = "/"),
  width = linewidth, height = height, units = "cm", res = 300)
  plot_grid(left_side, NULL, right_side, ncol = 3, rel_widths = c(1.5, 0.2, 1))
dev.off()

```

Simulation results
```{r}
# Get POUMM values for HIV spVL to annotate plot with
spvl_data <- data.frame(
        inference.method = "h.MWA.p.value",
        H2 = 3.9,
        alpha = 8.046)  # values are hand-calculated because the breaks scale is defined as seq(0.5, n.breaks - 0.5, 1) in plotting function

spvl_data$inference.method <- factor(
        spvl_data$inference.method,
        levels = c("h.plus.e.p.value", "h.MWA.p.value", "norm.z.p.value"),
        labels = c(e_name, ehat_name, z_minus_zbar_name))

# Summarize results for plotting
error.cols <- c("RMSE.z.h", "RMSE.h.MWA.h")

data.long <- do.call(
        what = tidyr::gather,
        args = c(error.cols, list(data = accuracy_simulation_results, key = "inference.method", value = "error")))

data.summary <- as.data.frame(
        data.long %>%
                dplyr::group_by(inference.method, alpha, H2, var.z, p) %>%
                dplyr::summarise(mean.error = mean(error), sd.error = sd(error), N.reps = dplyr::n()))

# Create facet variable labels for plot
data.summary$inference.method <- factor(
        data.summary$inference.method,
        levels = c("RMSE.h.MWA.h", "RMSE.z.h"),
        labels = c(ehat_name, z_minus_zbar_name))

# Plot RMSE
rmse_plot <- plotHeatmap(
        df = data.summary,
        N.sim = data.summary$N.reps[[1]],
        is.MLE = T,
        scale.limits = c(0, 1),
        legend.name = "RMSE",
        midpoint = 0.5,
        fill.hi = RColorBrewer::brewer.pal(name = 'PiYG', n = 3)[1],
        fill.lo = RColorBrewer::brewer.pal(name = 'PiYG', n = 3)[3],
        fill.mid = RColorBrewer::brewer.pal(name = 'PiYG', n = 3)[2],
        x.var = "alpha",
        y.var = "H2",
        fill.var = "mean.error",
        facet.x = "inference.method",
        facet.y = NA,
        is.oob.squish = F,
        is.real.scale = F,
        labeller = label_wrap_gen(width = 25)) +
        labs(x = expression("Selection strength (" * alpha * ")"),
             y = expression("spVL heritability (" * italic('H'^2) * ")")) +
        shared_theme +
        theme(axis.text.x = element_text(angle = 90)) +
        geom_point(data = spvl_data, fill = "black")

data <- tidyr::gather(
        data = tpr_simulation_results,
        key = "inference.method",
        value = "p.value",
        h.plus.e.p.value, norm.z.p.value, h.OU.p.value, h.MWA.p.value)

# Calculate TPR for each simulation
sig.level <- correctSignificanceLevelForMultTesting(
        significance.level = 0.05,
        significance.correction = "Bonferroni",
        N.tests = 20)
data$TP <- ifelse(data$p.value < sig.level & data$is.causal.variant, T, F)
data$FP <- ifelse(data$p.value < sig.level & !(data$is.causal.variant), T, F)
data.TPR <- as.data.frame(
        data %>%
                dplyr::group_by(runID, inference.method, alpha, sigma, H2, var.z, p, delta) %>%
                dplyr::summarise(
                        TPR = sum(TP, na.rm = T)/sum(is.causal.variant),
                        FP = sum(FP), K = dplyr::n(),
                        N.noncausal.variants = sum(!(is.causal.variant))))

# Summarize replicate simulations
data.summary <- as.data.frame(
        data.TPR %>%
                dplyr::group_by(inference.method, alpha, sigma, H2, var.z, p, delta) %>%
                dplyr::summarise(
                        mean.TPR = mean(TPR),
                        sd.TPR = sd(TPR),
                        mean.FP = mean(FP),
                        sd.FP = sd(FP),
                        N.noncausal.variants = mean(N.noncausal.variants),
                        N.sim = dplyr::n()))

# Create facet variable labels for plot
data.summary$inference.method <- factor(
        data.summary$inference.method,
        levels = c("h.plus.e.p.value", "h.MWA.p.value", "norm.z.p.value"),
        labels = c(e_name, ehat_name, z_minus_zbar_name))

# Plot TPR
tpr_plot <- makeTPRPlot(
        df = data.summary %>% filter(inference.method %in% c(e_name, ehat_name, z_minus_zbar_name)),
        is.MLE = T,
        midpoint = 0.5,
        fill.lo = RColorBrewer::brewer.pal(name = 'RdBu', n = 3)[3],
        fill.hi = RColorBrewer::brewer.pal(name = 'RdBu', n = 3)[1],
        fill.mid = RColorBrewer::brewer.pal(name = 'RdBu', n = 3)[2]) +
        facet_grid(. ~ inference.method, labeller = label_wrap_gen(width = 25)) +
        labs(x = expression("Selection strength (" * alpha * ")"),
             y = expression("spVL heritability (" * 'H'^2 * ")")) +
        shared_theme +
        theme(axis.text.x = element_text(angle = 90)) +
        geom_point(data = spvl_data, fill = "black")

top_row <- plot_grid(NULL, rmse_plot, rel_widths = c(1, 3.25), labels = c("", "A"))
png(filename = "figures/simulation_results.png", width = linewidth, height = height, unit = "cm", res = 300)
plot_grid(top_row, tpr_plot, align = "v", axis = "tb", nrow = 2, labels = c("", "B"))
dev.off()
```

Inferred phylogeny
```{r}

```

POUMM parameter estimates
```{r}

```

Estimated trait values
```{r}

```

PCA of cohort genotypes
```{r}

```

Manhattan plot of GWAS results
```{r}

```

Q-Q plot of GWAS results
```{r}

```
